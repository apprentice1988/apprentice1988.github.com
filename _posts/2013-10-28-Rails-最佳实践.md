---
layout: post
category: Rails
---
#### 1. 丰富模型，简化控制器

/app/controllers/tweets_controller.rb

```ruby
class TweetsController < ApplicationController
	def retweet
		tweet = Tweet.find(params[:id])

		if tweet.user == current_user
			flash[:notice] = "Sorry, you can't retweet your own tweets."
		elsif tweet.retweets.where(:user_id => current_user.id).present?
			flash[:notice] = "You already retweeted!"
		else
			t = Tweet.new
			t.status = "RT #{tweet.user.name}: #{tweet.status}"
			t.original_tweet = tweet
			t.user = current_user
			t.save
			flash[:notice] = "Successfully retweeted"
		end

		redirect_to tweet
	end
end
```
优化成：
/app/controllers/tweets_controller.rb

```ruby
class TweetsController < ApplicationController
	def retweet
		tweet = Tweet.find(params[:id])
		flash[:notice] = tweet.retweet_by(current_user)
		redirect_to tweet
	end
end
```

/app/models/tweet.rb

```ruby
class Tweet < ActiveRecord::Base
	def retweet_by(retweeter)
		if self.user == retweeter
			"Sorry, you can't retweet your own tweets"
		elsif self.retweets.where(:user_id => retweeter.id).present?
			"You already retweeted!"
		else
			...
			"Successfully retweeted"
		end
	end
end
```

#### 2. scope

Bad code:

/app/controllers/tweets_controller.rb

```ruby
def index
	@tweet = Tweet.find(
		:all,
		:conditions => {:user_id => current_user.id},
		:order => "created_at desc",
		:limit => 10
	)
	@trending = Topic.find(
		:all,
		:conditions => ["started_trending > ?",1.day.ago],
		:order => "mentions desc",
		:limit => 5
	)
	...
end
```

/app/controllers/tweets_controller.rb

```ruby
def index
	@tweets = Tweet.where(:user_id=>current_user.id).order("created_at desc").limit(10)

	@trending = Topic.where("started_trending > ?", 1.day.ago).order("mentions desc").limit(5)
	
	...
end

/app/controllers/tweets_controller.rb

```ruby
def index
  @tweets = current_user.tweets.order("created_at desc").limit(10)

  ...
end
```